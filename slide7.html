<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beneficios del Cuidado Ambiental</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Load the 3D Library: Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
        }
    }
    </script>
</head>
<body class="content-page">

    <div class="slide-container">
        <div class="card">
            <h2>Beneficios del Cuidado Ambiental</h2>
            <p>Gira el globo y haz clic en los íconos para explorar los retornos económicos, sociales y ambientales.</p>
            
            <!-- This container will hold the 3D scene -->
            <div id="scene-container"></div>
        </div>
    </div>

    <!-- Popup structure -->
    <div class="model-popup-overlay" id="model-popup-overlay">
        <div class="model-popup-panel">
            <button class="close-btn" id="close-model-popup-btn">&times;</button>
            <h3 id="model-popup-title"></h3>
            <p id="model-popup-description"></p>
        </div>
    </div>

    <script type="module">
        // Import necessary components from the Three.js library
        import * as THREE from 'three';
        // Corrected path to the controls addon
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- Data for the popups ---
        const benefitsData = {
            'recursos': { title: 'Conservación de Recursos Naturales', description: 'Protege y gestiona de manera sostenible los recursos vitales como el agua, el aire, la tierra y la biodiversidad, asegurando su disponibilidad para futuras generaciones.' },
            'eficiencia': { title: 'Eficiencia y Mitigación', description: 'Promueve el uso eficiente de la energía y otros recursos, reduciendo las emisiones de gases de efecto invernadero y mitigando los impactos del cambio climático.' },
            'economia': { title: 'Economía Circular', description: 'Impulsa el crecimiento económico y el empleo a través de la reducción, reutilización, reciclaje y recuperación de materiales, creando un sistema más resiliente y menos dependiente de recursos vírgenes.' }
        };

        // --- Basic Scene Setup ---
        const container = document.getElementById('scene-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 1, 3); // Move camera back

        // --- WebGL Renderer (for the 3D model) ---
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // --- CSS2D Renderer (for the HTML icons) ---
        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(container.clientWidth, container.clientHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        container.appendChild(labelRenderer.domElement);

        // --- Controls (for rotating the globe) ---
        const controls = new OrbitControls(camera, labelRenderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 2.5;
        controls.maxDistance = 6;

        // --- Lighting ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 5, 5);
        scene.add(dirLight);

        // --- GLTF Model Loader ---
        const loader = new GLTFLoader();
        loader.load('models/earth.glb', function (gltf) {
            const earth = gltf.scene;
            earth.scale.set(1.2, 1.2, 1.2); // Adjust scale if needed
            scene.add(earth);

            // --- THE FIX for Floating Icons ---
            // NOTE: You will likely need to adjust these X, Y, Z values to place the 
            // icons perfectly on the continents of YOUR specific 3D model.
            // A good way to find coordinates is to experiment with values between -1.3 and 1.3.
            const iconPositions = {
                recursos: new THREE.Vector3(-0.8, 0.7, 0.8),   // Approx. North America
                eficiencia: new THREE.Vector3(-0.3, -0.3, 1.3), // Approx. South America
                economia: new THREE.Vector3(1.2, 0.2, -0.5)      // Approx. Europe/Asia
            };

            for (const key in iconPositions) {
                const div = document.createElement('div');
                div.className = 'hotspot-icon';
                div.id = key;
                const label = new CSS2DObject(div);
                label.position.copy(iconPositions[key]);
                earth.add(label);
            }
            
            addClickListeners();
        });

        }, undefined, function (error) {
            console.error(error);
        });

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // For smooth damping
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
        animate();

        // --- Popup and Sound Logic ---
        const popupOverlay = document.getElementById('model-popup-overlay');
        const closeBtn = document.getElementById('close-model-popup-btn');
        const popupTitle = document.getElementById('model-popup-title');
        const popupDescription = document.getElementById('model-popup-description');

        function addClickListeners() {
            document.querySelectorAll('.hotspot-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const data = benefitsData[icon.id];
                    popupTitle.textContent = data.title;
                    popupDescription.textContent = data.description;
                    popupOverlay.classList.add('active');
                    if (window.parent && typeof window.parent.playClickSound === 'function') {
                        window.parent.playClickSound();
                    }
                });
            });
        }
        
        const closePopup = () => {
            popupOverlay.classList.remove('active');
            if (window.parent && typeof window.parent.playCloseSound === 'function') {
                window.parent.playCloseSound();
            }
        };

        closeBtn.addEventListener('click', closePopup);
        popupOverlay.addEventListener('click', e => { if (e.target === popupOverlay) closePopup(); });
        
    </script>

</body>
</html>

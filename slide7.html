<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beneficios del Cuidado Ambiental</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Load the 3D Library: Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
        }
    }
    </script>
</head>
<body class="content-page">

    <div class="slide-container">
        <div class="card">
            <h2>Beneficios del Cuidado Ambiental</h2>
            <p>Gira el globo y haz clic en los √≠conos para explorar los retornos econ√≥micos, sociales y ambientales.</p>
            
            <!-- This container will hold the 3D scene -->
            <div id="scene-container"></div>
        </div>
    </div>

    <!-- Popup structure -->
    <div class="model-popup-overlay" id="model-popup-overlay">
        <div class="model-popup-panel">
            <button class="close-btn" id="close-model-popup-btn">&times;</button>
            <h3 id="model-popup-title"></h3>
            <p id="model-popup-description"></p>
        </div>
    </div>

    <script type="module">
        // Import necessary components from the Three.js library
        import * as THREE from 'three';
        // Corrected path to the controls addon
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- Data for the popups ---
        const benefitsData = {
            'recursos': { title: 'Conservaci√≥n de Recursos Naturales', description: 'Protege y gestiona de manera sostenible los recursos vitales como el agua, el aire, la tierra y la biodiversidad, asegurando su disponibilidad para futuras generaciones.' },
            'eficiencia': { title: 'Eficiencia y Mitigaci√≥n', description: 'Promueve el uso eficiente de la energ√≠a y otros recursos, reduciendo las emisiones de gases de efecto invernadero y mitigando los impactos del cambio clim√°tico.' },
            'economia': { title: 'Econom√≠a Circular', description: 'Impulsa el crecimiento econ√≥mico y el empleo a trav√©s de la reducci√≥n, reutilizaci√≥n, reciclaje y recuperaci√≥n de materiales, creando un sistema m√°s resiliente y menos dependiente de recursos v√≠rgenes.' }
        };

        // --- Basic Scene Setup ---
        const container = document.getElementById('scene-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 1, 3); // Move camera back

        // --- WebGL Renderer (for the 3D model) ---
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // --- CSS2D Renderer (for the HTML icons) ---
        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(container.clientWidth, container.clientHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        container.appendChild(labelRenderer.domElement);

        // --- Controls (for rotating the globe) ---
        const controls = new OrbitControls(camera, labelRenderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 2.5;
        controls.maxDistance = 6;

        // --- Lighting ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 5, 5);
        scene.add(dirLight);

        // --- Popup Logic (moved up so it's available immediately) ---
        const popupOverlay = document.getElementById('model-popup-overlay');
        const closeBtn = document.getElementById('close-model-popup-btn');
        const popupTitle = document.getElementById('model-popup-title');
        const popupDescription = document.getElementById('model-popup-description');

        function showPopup(hotspotId) {
            console.log('Showing popup for:', hotspotId); // Debug log
            const data = benefitsData[hotspotId];
            if (data) {
                popupTitle.textContent = data.title;
                popupDescription.textContent = data.description;
                popupOverlay.classList.add('active');
                if (window.parent && typeof window.parent.playClickSound === 'function') {
                    window.parent.playClickSound();
                }
            }
        }
        
        const closePopup = () => {
            popupOverlay.classList.remove('active');
            if (window.parent && typeof window.parent.playCloseSound === 'function') {
                window.parent.playCloseSound();
            }
        };

        closeBtn.addEventListener('click', closePopup);
        popupOverlay.addEventListener('click', e => { if (e.target === popupOverlay) closePopup(); });

        // --- GLTF Model Loader with Fallback ---
        const loader = new GLTFLoader();
        
        loader.load(
            'models/earth.glb', 
            
            // Success callback
            function (gltf) {
                console.log('‚úÖ GLB model loaded successfully');
                const earth = gltf.scene;
                earth.scale.set(1.2, 1.2, 1.2);
                scene.add(earth);
                createHotspots(earth);
            }, 
            
            // Progress callback
            function (progress) {
                console.log('Loading progress:', Math.round(progress.loaded / progress.total * 100) + '%');
            },
            
            // Error callback - create fallback
            function (error) {
                console.warn('‚ùå GLB model failed to load:', error.message);
                console.log('üîÑ Creating fallback Earth...');
                createFallbackEarth();
            }
        );

        // Create fallback Earth when GLB fails
        function createFallbackEarth() {
            const earthGeometry = new THREE.SphereGeometry(1.2, 64, 64);
            
            // Create a simple Earth-like texture
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 256;
            const context = canvas.getContext('2d');
            
            // Ocean blue
            context.fillStyle = '#1e4d72';
            context.fillRect(0, 0, 512, 256);
            
            // Continents in green
            context.fillStyle = '#2d5a2d';
            // North America
            context.fillRect(80, 60, 60, 40);
            // Europe/Africa
            context.fillRect(200, 50, 80, 80);
            // Asia
            context.fillRect(320, 40, 100, 60);
            // South America
            context.fillRect(120, 120, 40, 80);
            // Australia
            context.fillRect(380, 140, 30, 20);
            
            const texture = new THREE.CanvasTexture(canvas);
            const earthMaterial = new THREE.MeshPhongMaterial({ map: texture });
            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earth);
            
            createHotspots(earth);
        }

        function createHotspots(earthObject) {
            console.log('Creating hotspots...');
            
            const iconPositions = {
                recursos: new THREE.Vector3(-0.8, 0.7, 0.8),   // North America
                eficiencia: new THREE.Vector3(-0.3, -0.3, 1.3), // South America
                economia: new THREE.Vector3(1.2, 0.2, -0.5)      // Europe/Asia
            };

            for (const key in iconPositions) {
                // Create the DOM element
                const div = document.createElement('div');
                div.className = 'hotspot-icon';
                div.id = key;
                
                // Add click handler directly to the element
                div.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Hotspot clicked:', key); // Debug log
                    showPopup(key);
                });
                
                // Add visual feedback on hover
                div.addEventListener('mouseenter', function() {
                    div.style.transform = 'scale(1.2)';
                });
                
                div.addEventListener('mouseleave', function() {
                    div.style.transform = 'scale(1)';
                });
                
                // Create Three.js label object
                const label = new CSS2DObject(div);
                label.position.copy(iconPositions[key]);
                earthObject.add(label);
                
                console.log('Created hotspot:', key, 'at position:', iconPositions[key]);
            }
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // For smooth damping
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            labelRenderer.setSize(container.clientWidth, container.clientHeight);
        });
        
    </script>

</body>
</html>
